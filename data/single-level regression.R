# Joshua Alley
# Texas A&M University
# State-year regression models of alliance conditions and arms


# Load packages
library(here)
library(dplyr)
library(texreg)
library(MASS)
library(plm)



# Set working directory to current folder 
setwd(here::here())
getwd()

# Environment is determined by use of projects and/or using this file in conjunction with
# the file dataset construction and summary.R 


# Regression is based on data from the state.char.full dataset, which 
# contains state-level variables, including summaries of alliance characteristics

# Create a couple new variables
state.char.full <- state.char.full %>%
  mutate(
    treaty.count = treaty.count - 1,
    prob.det.share = prob.det.total / treaty.count,
    comp.share = (uncond.comp.total + cond.comp.total) / treaty.count,
    uncond.det.share = uncond.det.total / treaty.count, 
    comp.pres = ifelse((uncond.comp.pres == 1 | cond.comp.pres == 1), 1 , 0),
    ln.rival.mil = log(rival.mil),
    consul.only.share = consul.only.total / treaty.count,
    offense.pres = ifelse((offense.total >= 1), 1 , 0),
    offense.share = offense.total / treaty.count, 
    defense.pres = ifelse((defense.total >= 1), 1 , 0),
    defense.share = defense.total / treaty.count,
    discret.inter.share = discret.inter.total / treaty.count,
    discret.mils.share = discret.mils.total / treaty.count
  )

state.char.full <- state.char.full[complete.cases(state.char.full$ccode), ]


# What states have these probabilistic deterrent pacts- wide variety
 state.char.full %>% filter(prob.det.pres == 1) %>% count(ccode)

# Sample is minor powers only, and those minor powers that have alliances
# otherwise, states with no alliances enter the base category, which may alter comparisons

# Start with a simple linear model 
m1.reg <- plm(ln.milex ~ prob.det.pres + uncond.det.pres + comp.pres  + avg.dem.prop + lag.ln.milex +
               atwar + civilwar + polity + ln.GDP + nato +
               ls.threatenv + cold.war + totalmilex.atop.ally,
             data = state.char.full, subset = (majpower == 0 & avg.num.mem != 0),
            effect = "twoways",  model = "within")

summary(m1.reg)
plot(density(m1.reg$residuals))

# Hausman test
m1.reg.re <- plm(ln.milex ~ prob.det.pres + uncond.det.pres + comp.pres  + avg.dem.prop + lag.ln.milex +
                atwar + civilwar + polity + ln.GDP + nato +
                ls.threatenv + cold.war + totalmilex.atop.ally,
              data = state.char.full, subset = (majpower == 0 & avg.num.mem != 0),
              effect = "twoways",  model = "random")
summary(m1.reg.re)

phtest(m1.reg, m1.reg.re, method = "aux")



# Use shares instead
m2.reg <- plm(ln.milex ~ prob.det.share + uncond.det.share + comp.share  + avg.dem.prop + lag.ln.milex +
               atwar + civilwar + polity + ln.GDP +
               ls.threatenv + cold.war + totalmilex.atop.ally, 
             data = state.char.full, subset = (majpower == 0 & avg.num.mem != 0),
             effect = c("twoways"))

summary(m2.reg)
plot(density(m2.reg$residuals))



# Hausman test
m2.reg.re <- plm(ln.milex ~  prob.det.share + uncond.det.share + comp.share + avg.dem.prop + lag.ln.milex +
                   atwar + civilwar + polity + ln.GDP + nato +
                   ls.threatenv + cold.war + totalmilex.atop.ally,
                 data = state.char.full, subset = (majpower == 0 & avg.num.mem != 0),
                 effect = "twoways",  model = "random")
summary(m2.reg.re)

phtest(m2.reg, m2.reg.re, method = "aux")





# Robust Regression 
###### 
# Residuals in the early models have some really heavy tails. Robust regression weights observations as 
# a function of their residual, ensuring least squares is still efficient
# Had trouble getting fixed effects into these models


# Start with a binary indicator of probabilistic deterrent pacts 
m1r.reg <- rlm(ln.milex ~ prob.det.pres + uncond.det.pres + comp.pres  + avg.dem.prop + lag.ln.milex +
                 atwar + civilwar + polity + ln.GDP +
                 ls.threatenv + totalmilex.atop.ally,
               data = state.char.full, subset = (majpower == 0 & avg.num.mem != 0))

summary(m1r.reg)
plot(m1r.reg$residuals, m1r.reg$w)

plotreg(m1r.reg, omit.coef = "Intercept")


# Use shares instead
m2r.reg <- rlm(ln.milex ~ prob.det.share + uncond.det.share + comp.share  + avg.dem.prop + lag.ln.milex +
                 atwar + civilwar + polity + ln.GDP +
                 ls.threatenv + totalmilex.atop.ally, 
               data = state.char.full, subset = (majpower == 0 & avg.num.mem != 0))

summary(m2r.reg)
plot(m2r.reg$residuals, m2r.reg$w)

plotreg(m2r.reg, omit.coef = "Intercept")







# Examine the component conditions of probabilistic deterrent alliances

# Use shares of treaties with discretion over intervention
m5.din <- rlm(ln.milex ~ discret.inter.share + uncond.det.share + avg.dem.prop + lag.ln.milex +
               atwar + civilwar + polity + ln.GDP +
               ls.threatenv + comp.share + totalmilex.atop.ally, 
             data = state.char.full, subset = (majpower == 0 & avg.num.mem != 0))

summary(m5.din)
plot(m5.din$residuals, m5.din$w)

plotreg(m5.din, omit.coef = "Intercept")




# Share of treaties with discretion over military support
m6.dmil <- rlm(ln.milex ~ discret.mils.share + uncond.det.share + comp.share + avg.dem.prop + lag.ln.milex +
                atwar + civilwar + polity + ln.GDP +
                ls.threatenv + totalmilex.atop.ally, 
              data = state.char.full, subset = (majpower == 0 & avg.num.mem != 0))

summary(m6.dmil)
plot(m6.dmil$residuals, m6.dmil$w)

plotreg(m6.dmil, omit.coef = "Intercept")


# Both shares variables in the same model
m7.dmil <- rlm(ln.milex ~ discret.inter.share + discret.mils.share + uncond.det.share + comp.share + avg.dem.prop + lag.ln.milex +
                 atwar + civilwar + polity + ln.GDP +
                 ls.threatenv + totalmilex.atop.ally, 
               data = state.char.full, subset = (majpower == 0 & avg.num.mem != 0))

summary(m7.dmil)
plot(m7.dmil$residuals, m7.dmil$w)

plotreg(m7.dmil, omit.coef = "Intercept")






### Consultation variable: Was Hypothesis 3 

########

# Use consultation variable 
m3.cons <- plm(ln.milex ~ consul.only.pres + offense.pres + defense.pres + avg.dem.prop + lag.ln.milex +
                atwar + civilwar + polity + ln.GDP +
                ls.threatenv + cold.war + totalmilex.atop.ally, 
              data = state.char.full, subset = (majpower == 0 & avg.num.mem != 0),
              effect = c("twoways"))

summary(m3.cons)
plot(density(m3.cons$residuals))



# Use consultation only as a share of total treaties 
m4.cons <- plm(ln.milex ~ consul.only.share + offense.share + defense.share + avg.dem.prop + lag.ln.milex +
                atwar + civilwar + polity + ln.GDP +
                ls.threatenv + cold.war + totalmilex.atop.ally, 
              data = state.char.full, subset = (majpower == 0 & avg.num.mem != 0),
              effect = c("twoways"))

summary(m4.cons)
plot(density(m4.cons$residuals))




### robust regression

# Use consultation variable 
m3r.cons <- rlm(ln.milex ~ consul.only.pres + offense.pres + defense.pres + avg.dem.prop + lag.ln.milex +
                  atwar + civilwar + polity + ln.GDP +
                  ls.threatenv + totalmilex.atop.ally, 
                data = state.char.full, subset = (majpower == 0 & avg.num.mem != 0))

summary(m3r.cons)
plot(m3r.cons$residuals, m3r.cons$w)

plotreg(m3r.cons, omit.coef = "Intercept")


# Use consultation only as a share of total treaties 
m4r.cons <- rlm(ln.milex ~ consul.only.share + offense.share + defense.share + avg.dem.prop + lag.ln.milex +
                  atwar + civilwar + polity + ln.GDP +
                  ls.threatenv + totalmilex.atop.ally, 
                data = state.char.full, subset = (majpower == 0 & avg.num.mem != 0))

summary(m4r.cons)
plot(m4r.cons$residuals, m4r.cons$w)

plotreg(m4r.cons, omit.coef = "Intercept")




